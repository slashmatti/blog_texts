var BlogTextsWidget = {
    circleStyles: { backgroundColor: 'black', height: '50px', width: '50px', borderRadius: '50%', position: 'absolute', bottom: '10px', right: '10px', cursor: 'pointer' },
    welcome_message: 'Send me a note!', // TODO: get these from the database
    formHtml: '<%= j render "form" %>',
    formId: 'new_message',
    cssStyles: '<%= asset_url("tailwind.css") %>',

    init: function() {
        console.log('widget initialized');
        this.showIcon();
        this.plantCss();
    },

    plantCss: function() {
        let stylesheet = document.createElement('link');
        stylesheet.rel = 'stylesheet';
        stylesheet.href = this.cssStyles;
        document.head.append(stylesheet);
    },

    showForm: function() {
        document.body.insertAdjacentHTML('beforeend', this.formHtml);
        document.getElementById('new_message').addEventListener('submit', this.submitForm);
        this.hideIcon();
        let closeButton = document.getElementById('blog_text_close');
        closeButton.addEventListener('click', this.hideForm.bind(this));
        this.enableAutosave();
    },

    hideForm: function() {
        document.getElementById('blog_text_widget').remove();
        this.showIcon();
    },

    hideIcon: function() {
        document.getElementById('blog_text_icon').remove();
    },

    sendMessage: function() { // maybe unnecessary
    },

    showIcon: function() {
        let icon = document.createElement('span');
        icon.id = 'blog_text_icon';
        icon.addEventListener('click', this.showForm.bind(this));

        Object.assign(icon.style, this.circleStyles);

        document.body.append(icon);
    },

    enableAutosave: function() {
        ['name', 'email'].forEach(function(formField) {
            // attach autosave functionality to name, email form fields
            let fieldEl = document.getElementById('message_' + formField);
      
            fieldEl.addEventListener('change', function() {
              localStorage.setItem('BlogTextWidget' + '_' + formField, fieldEl.value);
            })
      
            // retrieve existing autosaved value; if exists, prefill input
            let savedValue = localStorage.getItem('BlogTextWidget' + '_' + formField);
      
            if (savedValue != null) {
              fieldEl.value = savedValue;
            }
          })
        },

    submitForm: function(e) {
        e.preventDefault();
        let form = e.target;
        fetch(form.action, {
            method: 'POST',
            body: new FormData(form)
        }).then((response) => {
            var thanks = document.createElement('p');
            thanks.textContent = 'Thanks! Your message has been sent.';
            thanks.classList.add('bg-white');
            // debugger;
            var form = document.getElementById('new_message');
            form.appendChild(thanks);
            setTimeout(() => {
                BlogTextsWidget.hideForm();
              }, 5000);
        })
    }
}

BlogTextsWidget.init();